<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Getting Started with Kubernetes &mdash; NVIDIA Network Operator v24.10.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" type="text/css" />
      <link rel="stylesheet" href="_static/omni-style.css" type="text/css" />
      <link rel="stylesheet" href="_static/api-styles.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/mermaid-init.js"></script>
        <script src="_static/design-tabs.js"></script>
        <script src="_static/version.js"></script>
        <script src="_static/social-media.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Getting Started with Red Hat OpenShift" href="getting-started-openshift.html" />
    <link rel="prev" title="Platform Support" href="platform-support.html" />
 


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >


<a href="index.html">
  <img src="_static/nvidia-logo-white.png" class="logo" alt="Logo"/>
</a>

<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">NVIDIA Network Operator</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="platform-support.html">Platform Support</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting Started with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started-openshift.html">Getting Started with Red Hat OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="customizations/customization.html">Customization Options and CRDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="life-cycle-management.html">Life Cycle Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced-configurations.html">Advanced Configurations</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NVIDIA Network Operator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">


<li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
  
<li>Getting Started with Kubernetes</li>

      <li class="wy-breadcrumbs-aside">
      </li>
<li class="wy-breadcrumbs-aside">

  <span>&nbsp;</span>
</li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="getting-started-with-kubernetes">
<h1>Getting Started with Kubernetes<a class="headerlink" href="#getting-started-with-kubernetes" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#network-operator-deployment-guide" id="id20">Network Operator Deployment Guide</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id21">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-on-vanilla-kubernetes-cluster" id="id22">Network Operator Deployment on Vanilla Kubernetes Cluster</a></p></li>
<li><p><a class="reference internal" href="#deployment-examples" id="id23">Deployment Examples</a></p>
<ul>
<li><p><a class="reference internal" href="#network-operator-deployment-with-rdma-shared-device-plugin" id="id24">Network Operator Deployment with RDMA Shared Device Plugin</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-with-multiple-resources-in-rdma-shared-device-plugin" id="id25">Network Operator Deployment with Multiple Resources in RDMA Shared Device Plugin</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-with-a-secondary-network" id="id26">Network Operator Deployment with a Secondary Network</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-with-nvidia-ipam" id="id27">Network Operator Deployment with NVIDIA-IPAM</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-with-a-host-device-network" id="id28">Network Operator Deployment with a Host Device Network</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-with-a-host-device-network-and-macvlan-network" id="id29">Network Operator Deployment with a Host Device Network and Macvlan Network</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-with-an-ip-over-infiniband-ipoib-network" id="id30">Network Operator Deployment with an IP over InfiniBand (IPoIB) Network</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-for-gpudirect-workloads" id="id31">Network Operator Deployment for GPUDirect Workloads</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-in-sr-iov-legacy-mode" id="id32">Network Operator Deployment in SR-IOV Legacy Mode</a></p></li>
<li><p><a class="reference internal" href="#sr-iov-network-operator-deployment-parallel-node-configuration-for-sr-iov" id="id33">SR-IOV Network Operator Deployment – Parallel Node Configuration for SR-IOV</a></p>
<ul>
<li><p><a class="reference internal" href="#upgrade-from-nvidia-network-operator-v24-1-0" id="id34">Upgrade from NVIDIA Network Operator v24.1.0</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sr-iov-network-operator-deployment-parallel-nic-configuration-for-sr-iov" id="id35">SR-IOV Network Operator Deployment – Parallel NIC Configuration for SR-IOV</a></p></li>
<li><p><a class="reference internal" href="#sr-iov-network-operator-deployment-sr-iov-using-the-systemd-service" id="id36">SR-IOV Network Operator Deployment – SR-IOV Using the systemd Service</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-with-an-sr-iov-infiniband-network" id="id37">Network Operator Deployment with an SR-IOV InfiniBand Network</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-with-an-sr-iov-infiniband-network-with-pkey-management" id="id38">Network Operator Deployment with an SR-IOV InfiniBand Network with PKey Management</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-for-dpdk-workloads-with-nicclusterpolicy" id="id39">Network Operator Deployment for DPDK Workloads with NicClusterPolicy</a></p></li>
<li><p><a class="reference internal" href="#network-operator-deployment-and-openvswitch-offload-managed-openvswitch" id="id40">Network Operator Deployment and OpenvSwitch offload - managed OpenvSwitch</a></p>
<ul>
<li><p><a class="reference internal" href="#network-operator-configuration" id="id41">Network Operator Configuration</a></p></li>
<li><p><a class="reference internal" href="#prerequisites-for-worker-nodes" id="id42">Prerequisites for Worker Nodes</a></p></li>
<li><p><a class="reference internal" href="#ovs-kernel" id="id43">OVS-kernel</a></p></li>
<li><p><a class="reference internal" href="#ovs-doca" id="id44">OVS-doca</a></p></li>
<li><p><a class="reference internal" href="#test-workload" id="id45">Test Workload</a></p></li>
<li><p><a class="reference internal" href="#troubleshooting-ovs" id="id46">Troubleshooting OVS</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#network-operator-deployment-and-openvswitch-offload-externally-managed-openvswitch-with-vf-lag" id="id47">Network Operator Deployment and OpenvSwitch offload - externally managed OpenvSwitch with VF lag</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id48">Network Operator Configuration</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id49">Prerequisites for Worker Nodes</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id50">OVS-kernel</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id51">OVS-doca</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id52">Test Workload</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id53">Troubleshooting OVS</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="network-operator-deployment-guide">
<h2>Network Operator Deployment Guide<a class="headerlink" href="#network-operator-deployment-guide" title="Permalink to this headline"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The Network Operator Release Notes chapter is available <a class="reference external" href="./release-notes.html">here</a>.</p>
</div>
<p>NVIDIA Network Operator leverages <a class="reference external" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Kubernetes CRDs</a> and <a class="reference external" href="https://github.com/operator-framework/operator-sdk">Operator SDK</a> to manage networking related components in order to enable fast networking, RDMA and GPUDirect for workloads in a Kubernetes cluster. The Network Operator works in conjunction with the <a class="reference external" href="https://github.com/NVIDIA/gpu-operator">GPU-Operator</a> to enable GPU-Direct RDMA on compatible systems.</p>
<p>The goal of the Network Operator is to manage the networking related components, while enabling execution of RDMA and GPUDirect RDMA workloads in a Kubernetes cluster. This includes:</p>
<ul class="simple">
<li><p>NVIDIA Networking drivers to enable advanced features - enp1 netdcreate, an NV-IPAM IPPool</p></li>
<li><p>Kubernetes device plugins to provide hardware resources required for an accelerated network</p></li>
<li><p>Kubernetes secondary network components for network intensive workloads</p></li>
</ul>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline"></a></h2>
<ol class="arabic">
<li><p>You have the <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> and <code class="docutils literal notranslate"><span class="pre">helm</span></code> CLIs available on a client machine.</p>
<p>You can run the following commands to install the Helm CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 <span class="se">\</span>
    <span class="o">&amp;&amp;</span> chmod <span class="m">700</span> get_helm.sh <span class="se">\</span>
    <span class="o">&amp;&amp;</span> ./get_helm.sh
</pre></div>
</div>
</li>
<li><p>Nodes must be configured with a container engine such CRI-O or containerd.</p></li>
<li><p>If your cluster uses Pod Security Admission (PSA) to restrict the behavior of pods,
label the namespace for the Operator to set the enforcement policy to privileged:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl create ns nvidia-network-operator
$ kubectl label --overwrite ns nvidia-network-operator pod-security.kubernetes.io/enforce<span class="o">=</span>privileged
</pre></div>
</div>
</li>
<li><p>Node Feature Discovery (NFD) is a dependency for the Operator on each node.
By default, NFD master and worker are automatically deployed by the Operator.
If NFD is already running in the cluster, then you must disable deploying NFD when you install the Operator.
by setting <code class="docutils literal notranslate"><span class="pre">nfd.enabled=false</span></code> Helm value</p>
<p>One way to determine if NFD is already running in the cluster is to check for a NFD label on your nodes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get nodes -o json <span class="p">|</span> jq <span class="s1">&#39;.items[].metadata.labels | keys | any(startswith(&quot;feature.node.kubernetes.io&quot;))&#39;</span>
</pre></div>
</div>
<p>If the command output is <code class="docutils literal notranslate"><span class="pre">true</span></code>, then NFD is already running in the cluster.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>NFD needs to support NodeFeatureRules API or it should be configured to expose the needed NIC labels.
Deploying NFD from either NVIDIA Network Operator or NVIDIA GPU Operator will have the correct configurations for both Operators.</p>
</div>
</li>
</ol>
</section>
<section id="network-operator-deployment-on-vanilla-kubernetes-cluster">
<h2>Network Operator Deployment on Vanilla Kubernetes Cluster<a class="headerlink" href="#network-operator-deployment-on-vanilla-kubernetes-cluster" title="Permalink to this headline"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is recommended to have dedicated control plane nodes for Vanilla Kubernetes deployments with NVIDIA Network Operator.</p>
</div>
<p>The default installation via Helm as described below will deploy the Network Operator and related CRDs, after which an additional step is required to create a NicClusterPolicy custom resource with the configuration that is desired for the cluster.</p>
<p>For more information on NicClusterPolicy custom resource, please refer to the <a class="reference external" href="https://github.com/Mellanox/network-operator#nicclusterpolicy-crd">Network-Operator Project Sources</a>.</p>
<p>The provided Helm chart contains various parameters to facilitate the creation of a NicClusterPolicy custom resource upon deployment.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Each Network Operator Release has a set of default version values for the various components it deploys. It is recommended that these values will not be changed. Testing and validation were performed with these values, and there is no guarantee of interoperability nor correctness when different versions are used.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">Add NVIDIA NGC Helm repository</span><a class="headerlink" href="#id17" title="Permalink to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>helm repo add nvidia https://helm.ngc.nvidia.com/nvidia
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">Update helm repositories</span><a class="headerlink" href="#id18" title="Permalink to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>helm repo update
</pre></div>
</div>
</div>
<p>Install Network Operator from the NVIDIA NGC chart using the default values:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span> helm install network-operator nvidia/network-operator <span class="se">\</span>
   -n nvidia-network-operator <span class="se">\</span>
   --create-namespace <span class="se">\</span>
   --version v24.10.0-beta.5 <span class="se">\</span>
   --wait
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">View deployed resources</span><a class="headerlink" href="#id19" title="Permalink to this code"></a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl -n nvidia-network-operator get pods
</pre></div>
</div>
</div>
<p>Install the Network Operator from the NVIDIA NGC chart using custom values:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Since several parameters should be provided when creating custom resources during operator deployment, it is recommended to use a configuration file. While it is possible to override the parameters via CLI, we recommend to avoid the use of CLI arguments in favor of a configuration file.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>helm show values nvidia/network-operator --version v24.10.0-beta.5 &gt; values.yaml
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span> helm install network-operator nvidia/network-operator <span class="se">\</span>
   -n nvidia-network-operator <span class="se">\</span>
   --create-namespace <span class="se">\</span>
   --version v24.10.0-beta.5 <span class="se">\</span>
   -f ./values.yaml <span class="se">\</span>
   --wait
</pre></div>
</div>
</section>
<section id="deployment-examples">
<h2>Deployment Examples<a class="headerlink" href="#deployment-examples" title="Permalink to this headline"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Since several parameters should be provided when creating custom resources during operator deployment, it is recommended to use a configuration file. While it is possible to override the parameters via CLI, we recommend to avoid the use of CLI arguments in favor of a configuration file.</p>
</div>
<p>Below are deployment examples, which the <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file provided to the Helm during the installation of the network operator. This was achieved by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>helm install -f ./values.yaml -n nvidia-network-operator --create-namespace --wait nvidia/network-operator network-operator
</pre></div>
</div>
<section id="network-operator-deployment-with-rdma-shared-device-plugin">
<h3>Network Operator Deployment with RDMA Shared Device Plugin<a class="headerlink" href="#network-operator-deployment-with-rdma-shared-device-plugin" title="Permalink to this headline"></a></h3>
<p>First install the Network Operator with NFD enabled:</p>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator is installed create a NicClusterPolicy with
* DOCA driver
* RDMA Shared device plugin configured to a netdev with name ens1f0.</p>
<p>Note: You may need to change the interface names in the NicClusterPolicy to those used by your target nodes.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">ofedDriver</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doca-driver</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24.10-0.6.2.0-0</span><span class="w"></span>
<span class="w">     </span><span class="nt">forcePrecompiled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">     </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">     </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">upgradePolicy</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">autoUpgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">       </span><span class="nt">maxParallelUpgrades</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">       </span><span class="nt">safeLoad</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">       </span><span class="nt">drain</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">force</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">         </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">         </span><span class="nt">deleteEmptyDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">   </span><span class="nt">rdmaSharedDevicePlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="c1"># [map[ifNames:[ens1f0] name:rdma_shared_device_a]]</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-rdma-shared-dev-plugin</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sha-4f3eb2224b8b5f97be3f17441ddee8d41753b7d5</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="c1"># The config below directly propagates to k8s-rdma-shared-device-plugin configuration.</span><span class="w"></span>
<span class="w">     </span><span class="c1"># Replace &#39;devices&#39; with your (RDMA capable) netdevice name.</span><span class="w"></span>
<span class="w">     </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">       </span><span class="no">{</span><span class="w"></span>
<span class="w">         </span><span class="no">&quot;configList&quot;: [</span><span class="w"></span>
<span class="w">           </span><span class="no">{</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourceName&quot;: &quot;rdma_shared_device_a&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;rdmaHcaMax&quot;: 63,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;vendors&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;deviceIDs&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;drivers&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;ifNames&quot;: [&quot;ens1f0&quot;],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;linkTypes&quot;: []</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">           </span><span class="no">}</span><span class="w"></span>
<span class="w">         </span><span class="no">]</span><span class="w"></span>
<span class="w">       </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-with-multiple-resources-in-rdma-shared-device-plugin">
<h3>Network Operator Deployment with Multiple Resources in RDMA Shared Device Plugin<a class="headerlink" href="#network-operator-deployment-with-multiple-resources-in-rdma-shared-device-plugin" title="Permalink to this headline"></a></h3>
<p>First install the Network Operator with NFD enabled:</p>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator is installed create a NicClusterPolicy with:
* DOCA driver
* RDMA Shared Device pluging with two RDMA resources - the first mapped to ens1f0 and ens1f1 and the second mapped to ens2f0 and ens2f1.</p>
<p>Note: You may need to change the interface names in the NicClusterPolicy to those used by your target nodes.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">ofedDriver</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doca-driver</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24.10-0.6.2.0-0</span><span class="w"></span>
<span class="w">     </span><span class="nt">forcePrecompiled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">     </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">     </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">upgradePolicy</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">autoUpgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">       </span><span class="nt">maxParallelUpgrades</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">       </span><span class="nt">safeLoad</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">       </span><span class="nt">drain</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">force</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">         </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">         </span><span class="nt">deleteEmptyDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">   </span><span class="nt">rdmaSharedDevicePlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="c1"># [map[ifNames:[ens1f0 ens1f1] name:rdma_shared_device_a] map[ifNames:[ens2f0 ens2f1] name:rdma_shared_device_b]]</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-rdma-shared-dev-plugin</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sha-4f3eb2224b8b5f97be3f17441ddee8d41753b7d5</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="c1"># The config below directly propagates to k8s-rdma-shared-device-plugin configuration.</span><span class="w"></span>
<span class="w">     </span><span class="c1"># Replace &#39;devices&#39; with your (RDMA capable) netdevice name.</span><span class="w"></span>
<span class="w">     </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">       </span><span class="no">{</span><span class="w"></span>
<span class="w">         </span><span class="no">&quot;configList&quot;: [</span><span class="w"></span>
<span class="w">           </span><span class="no">{</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourceName&quot;: &quot;rdma_shared_device_a&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;rdmaHcaMax&quot;: 63,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;vendors&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;deviceIDs&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;drivers&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;ifNames&quot;: [&quot;ens1f0&quot;,&quot;ens1f1&quot;],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;linkTypes&quot;: []</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">           </span><span class="no">},</span><span class="w"></span>
<span class="w">           </span><span class="no">{</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourceName&quot;: &quot;rdma_shared_device_b&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;rdmaHcaMax&quot;: 63,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;vendors&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;deviceIDs&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;drivers&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;ifNames&quot;: [&quot;ens2f0&quot;,&quot;ens2f1&quot;],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;linkTypes&quot;: []</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">           </span><span class="no">}</span><span class="w"></span>
<span class="w">         </span><span class="no">]</span><span class="w"></span>
<span class="w">       </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-with-a-secondary-network">
<h3>Network Operator Deployment with a Secondary Network<a class="headerlink" href="#network-operator-deployment-with-a-secondary-network" title="Permalink to this headline"></a></h3>
<p>First install the Network Operator with NFD enabled:</p>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator is installed create a NicClusterPolicy with the following enabled:
* Secondary network
* Multus CNI
* Container-networking-plugins CNI plugins
* IPAM Plugin</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipamPlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.7.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-with-nvidia-ipam">
<h3>Network Operator Deployment with NVIDIA-IPAM<a class="headerlink" href="#network-operator-deployment-with-nvidia-ipam" title="Permalink to this headline"></a></h3>
<p>First install the Network Operator with NFD enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<dl class="simple">
<dt>Once the Network Operator is installed deploy a NicClusterPolicy with the following enabled:</dt><dd><ul class="simple">
<li><p>Secondary network</p></li>
<li><p>Multus CNI</p></li>
<li><p>Container Networking plugins</p></li>
<li><p>NVIDIA-IPAM plugin</p></li>
</ul>
</dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">   </span><span class="nt">nvIpam</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-k8s-ipam</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.2.0</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">enableWebhook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
</pre></div>
</div>
<p>To create an NV-IPAM IPPool, apply:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nv-ipam.nvidia.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-pool</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.0/24</span><span class="w"></span>
<span class="w">  </span><span class="nt">perNodeBlockSize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w"></span>
<span class="w">  </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.1</span><span class="w"></span>
</pre></div>
</div>
<p>Example of a MacvlanNetwork that uses NVIDIA-IPAM:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MacvlanNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-macvlannetwork</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">master</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ens2f0&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bridge&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;nv-ipam&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;poolName&quot;: &quot;my-pool&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-with-a-host-device-network">
<h3>Network Operator Deployment with a Host Device Network<a class="headerlink" href="#network-operator-deployment-with-a-host-device-network" title="Permalink to this headline"></a></h3>
<p>In this mode, the Network Operator could be deployed on virtualized deployments as well. It supports both Ethernet and InfiniBand modes. From the Network Operator perspective, there is no difference between the deployment procedures. To work on a VM (virtual machine), the PCI passthrough must be configured for SR-IOV devices. The Network Operator works both with VF (Virtual Function) and PF (Physical Function) inside the VMs.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the Host Device Network is used without the MLNX_OFED driver, the following packages should be installed:</p>
<ul class="simple">
<li><p>the linux-generic package on Ubuntu hosts</p></li>
<li><p>the kernel-modules-extra package on the RedHat-based hosts</p></li>
</ul>
</div>
<p>First install the Network Operator with NFD enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<dl class="simple">
<dt>Once the Network Operator is installed deploy a NicClusterPolicy with:</dt><dd><ul class="simple">
<li><p>SR-IOV device plugin configured with a single SR-IOV resource pool</p></li>
<li><p>Secondary network</p></li>
<li><p>Multus CNI</p></li>
<li><p>Container Networking plugins</p></li>
<li><p>IPAM plugin</p></li>
</ul>
</dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">sriovDevicePlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-network-device-plugin</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.7.0</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">       </span><span class="no">{</span><span class="w"></span>
<span class="w">         </span><span class="no">&quot;resourceList&quot;: [</span><span class="w"></span>
<span class="w">           </span><span class="no">{</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourcePrefix&quot;: &quot;nvidia.com&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourceName&quot;: &quot;hostdev&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;vendors&quot;: [&quot;15b3&quot;],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;devices&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;drivers&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;pfNames&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;pciAddresses&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;rootDevices&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;linkTypes&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;isRdma&quot;: true</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">           </span><span class="no">}</span><span class="w"></span>
<span class="w">         </span><span class="no">]</span><span class="w"></span>
<span class="w">       </span><span class="no">}</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipamPlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.7.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p>Following the deployment, the network operator should be configured, and K8s networking should be deployed to use it in pod configuration.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">host-device-net.yaml</span></code> configuration file for such a deployment:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HostDeviceNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostdev-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/hostdev&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;datastore&quot;: &quot;kubernetes&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;kubernetes&quot;: {</span><span class="w"></span>
<span class="w">        </span><span class="no">&quot;kubeconfig&quot;: &quot;/etc/cni/net.d/whereabouts.d/whereabouts.kubeconfig&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">},</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.3.225/28&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;exclude&quot;: [</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.229/30&quot;,</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.236/32&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">],</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_file&quot;: &quot;/var/log/whereabouts.log&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_level&quot;: &quot;info&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">host-device-net-ocp.yaml</span></code> configuration file for such a deployment in the OpenShift Platform:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HostDeviceNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostdev-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com/hostdev&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.3.225/28&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;exclude&quot;: [</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.229/30&quot;,</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.236/32&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">]</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">pod.yaml</span></code> configuration file for such a deployment:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostdev-test-pod</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostdev-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OnFailure</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mofed-test-ctr</span><span class="w"></span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;IPC_LOCK&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/hostdev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/hostdev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep inf</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-with-a-host-device-network-and-macvlan-network">
<h3>Network Operator Deployment with a Host Device Network and Macvlan Network<a class="headerlink" href="#network-operator-deployment-with-a-host-device-network-and-macvlan-network" title="Permalink to this headline"></a></h3>
<p>In this combined deployment, different NVIDIA NICs are used for RDMA Shared Device Plugin and SR-IOV Network Device Plugin in order to work with a Host Device Network or a Macvlan Network on different NICs. It is impossible to combine different networking types on the same NICs. The same principle should be applied for other networking combinations.</p>
<p>First install the Network Operator with NFD enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<dl class="simple">
<dt>Once the Network Operator is installed deploy a NicClusterPolicy with:</dt><dd><ul class="simple">
<li><p>RDMA shared device plugin with</p></li>
<li><p>SR-IOV device plugin, single SR-IOV resource pool</p></li>
<li><p>Secondary network</p></li>
<li><p>Multus CNI</p></li>
<li><p>Container-networking-plugins CNI plugins</p></li>
<li><p>RDMA Shared device plugin</p></li>
<li><p>Whereabouts IPAM CNI plugin</p></li>
</ul>
</dd>
</dl>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">rdmaSharedDevicePlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="c1"># [map[linkTypes:[ether] name:rdma_shared_device_a]]</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-rdma-shared-dev-plugin</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sha-4f3eb2224b8b5f97be3f17441ddee8d41753b7d5</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="c1"># The config below directly propagates to k8s-rdma-shared-device-plugin configuration.</span><span class="w"></span>
<span class="w">     </span><span class="c1"># Replace &#39;devices&#39; with your (RDMA capable) netdevice name.</span><span class="w"></span>
<span class="w">     </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">       </span><span class="no">{</span><span class="w"></span>
<span class="w">         </span><span class="no">&quot;configList&quot;: [</span><span class="w"></span>
<span class="w">           </span><span class="no">{</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourceName&quot;: &quot;rdma_shared_device_a&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;rdmaHcaMax&quot;: 63,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;vendors&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;deviceIDs&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;drivers&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;ifNames&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;linkTypes&quot;: [&quot;ether&quot;]</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">           </span><span class="no">}</span><span class="w"></span>
<span class="w">         </span><span class="no">]</span><span class="w"></span>
<span class="w">       </span><span class="no">}</span><span class="w"></span>
<span class="w">   </span><span class="nt">sriovDevicePlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-network-device-plugin</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.7.0</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">       </span><span class="no">{</span><span class="w"></span>
<span class="w">         </span><span class="no">&quot;resourceList&quot;: [</span><span class="w"></span>
<span class="w">           </span><span class="no">{</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourcePrefix&quot;: &quot;nvidia.com&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourceName&quot;: &quot;hostdev&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;vendors&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;devices&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;drivers&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;pfNames&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;pciAddresses&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;rootDevices&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;linkTypes&quot;: [&quot;IB&quot;],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;isRdma&quot;: true</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">           </span><span class="no">}</span><span class="w"></span>
<span class="w">         </span><span class="no">]</span><span class="w"></span>
<span class="w">       </span><span class="no">}</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipamPlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.7.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p>For pods and network configuration examples please refer to the corresponding sections: Network Operator Deployment with the RDMA Shared Device Plugin and Network Operator Deployment with a Host Device Network.</p>
</section>
<section id="network-operator-deployment-with-an-ip-over-infiniband-ipoib-network">
<h3>Network Operator Deployment with an IP over InfiniBand (IPoIB) Network<a class="headerlink" href="#network-operator-deployment-with-an-ip-over-infiniband-ipoib-network" title="Permalink to this headline"></a></h3>
<p>In this mode, the Network Operator could be deployed on virtualized deployments as well. It supports both Ethernet and InfiniBand modes. From the Network Operator perspective, there is no difference between the deployment procedures. To work on a VM (virtual machine), the PCI passthrough must be configured for SR-IOV devices. The Network Operator works both with VF (Virtual Function) and PF (Physical Function) inside the VMs.</p>
<p>First install the Network Operator with NFD enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator is installed create a NicClusterPolicy with:
* DOCA driver
* RDMA shared device plugin
* Secondary network
* Multus CNI
* IPoIB CNI
* Whereabouts IPAM CNI plugin</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">ofedDriver</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doca-driver</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24.10-0.6.2.0-0</span><span class="w"></span>
<span class="w">     </span><span class="nt">forcePrecompiled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">     </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">     </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">upgradePolicy</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">autoUpgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">       </span><span class="nt">maxParallelUpgrades</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">       </span><span class="nt">safeLoad</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">       </span><span class="nt">drain</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">force</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">         </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">         </span><span class="nt">deleteEmptyDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">   </span><span class="nt">rdmaSharedDevicePlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="c1"># [map[ifNames:[ibs1f0] name:rdma_shared_device_a]]</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-rdma-shared-dev-plugin</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sha-4f3eb2224b8b5f97be3f17441ddee8d41753b7d5</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="c1"># The config below directly propagates to k8s-rdma-shared-device-plugin configuration.</span><span class="w"></span>
<span class="w">     </span><span class="c1"># Replace &#39;devices&#39; with your (RDMA capable) netdevice name.</span><span class="w"></span>
<span class="w">     </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">       </span><span class="no">{</span><span class="w"></span>
<span class="w">         </span><span class="no">&quot;configList&quot;: [</span><span class="w"></span>
<span class="w">           </span><span class="no">{</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourceName&quot;: &quot;rdma_shared_device_a&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;rdmaHcaMax&quot;: 63,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;vendors&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;deviceIDs&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;drivers&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;ifNames&quot;: [&quot;ibs1f0&quot;],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;linkTypes&quot;: []</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">           </span><span class="no">}</span><span class="w"></span>
<span class="w">         </span><span class="no">]</span><span class="w"></span>
<span class="w">       </span><span class="no">}</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipoib</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipoib-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">428715a57c0b633e48ec7620f6e3af6863149ccf</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipamPlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.7.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p>Following the deployment, the network operator should be configured, and K8s networking deployed to use it in the pod configuration.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ipoib-net.yaml</span></code> configuration file for such a deployment:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPoIBNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-ipoibnetwork</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">master</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ibs1f0&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;datastore&quot;: &quot;kubernetes&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;kubernetes&quot;: {</span><span class="w"></span>
<span class="w">        </span><span class="no">&quot;kubeconfig&quot;: &quot;/etc/cni/net.d/whereabouts.d/whereabouts.kubeconfig&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">},</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.5.225/28&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;exclude&quot;: [</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.6.229/30&quot;,</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.6.236/32&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">],</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_file&quot; : &quot;/var/log/whereabouts.log&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_level&quot; : &quot;info&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;gateway&quot;: &quot;192.168.6.1&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ipoib-net-ocp.yaml</span></code> configuration file for such a deployment in the OpenShift Platform:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPoIBNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-ipoibnetwork</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">master</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ibs1f0&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.5.225/28&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;exclude&quot;: [</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.6.229/30&quot;,</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.6.236/32&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">]</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">pod.yaml</span></code> configuration file for such a deployment:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iboip-test-pod</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-ipoibnetwork</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OnFailure</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mofed-test-ctr</span><span class="w"></span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;IPC_LOCK&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">rdma/rdma_shared_device_a</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">edma/rdma_shared_device_a</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep inf</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-for-gpudirect-workloads">
<h3>Network Operator Deployment for GPUDirect Workloads<a class="headerlink" href="#network-operator-deployment-for-gpudirect-workloads" title="Permalink to this headline"></a></h3>
<p>GPUDirect requires the following:</p>
<ul class="simple">
<li><p>NVIDIA DOCA Driver v5.5-1.0.3.2 or newer</p></li>
<li><p>GPU Operator v1.9.0 or newer</p></li>
<li><p>NVIDIA GPU and driver supporting GPUDirect e.g Quadro RTX 6000/8000 or NVIDIA T4/NVIDIA V100/NVIDIA A100</p></li>
</ul>
<p>First install the Network Operator with NFD enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator is installed create a NicClusterPolicy with:
* DOCA driver
* SR-IOV Device Plugin
* Secondary network
* Multus CNI
* Container Networking plugins
* IPAM plugin</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">ofedDriver</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doca-driver</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24.10-0.6.2.0-0</span><span class="w"></span>
<span class="w">     </span><span class="nt">forcePrecompiled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">     </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">     </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">upgradePolicy</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">autoUpgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">       </span><span class="nt">maxParallelUpgrades</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">       </span><span class="nt">safeLoad</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">       </span><span class="nt">drain</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">force</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">         </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">         </span><span class="nt">deleteEmptyDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">   </span><span class="nt">sriovDevicePlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-network-device-plugin</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.7.0</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">       </span><span class="no">{</span><span class="w"></span>
<span class="w">         </span><span class="no">&quot;resourceList&quot;: [</span><span class="w"></span>
<span class="w">           </span><span class="no">{</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourcePrefix&quot;: &quot;nvidia.com&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;resourceName&quot;: &quot;hostdev&quot;,</span><span class="w"></span>
<span class="w">             </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;vendors&quot;: [&quot;15b3&quot;],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;devices&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;drivers&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;pfNames&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;pciAddresses&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;rootDevices&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;linkTypes&quot;: [],</span><span class="w"></span>
<span class="w">               </span><span class="no">&quot;isRdma&quot;: true</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">           </span><span class="no">}</span><span class="w"></span>
<span class="w">         </span><span class="no">]</span><span class="w"></span>
<span class="w">       </span><span class="no">}</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipamPlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.7.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">host-device-net.yaml:</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HostDeviceNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostdevice-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;hostdev&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;datastore&quot;: &quot;kubernetes&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;kubernetes&quot;: {</span><span class="w"></span>
<span class="w">        </span><span class="no">&quot;kubeconfig&quot;: &quot;/etc/cni/net.d/whereabouts.d/whereabouts.kubeconfig&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">},</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.3.225/28&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;exclude&quot;: [</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.229/30&quot;,</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.236/32&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">],</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_file&quot; : &quot;/var/log/whereabouts.log&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_level&quot; : &quot;info&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">host-device-net-ocp.yaml</span></code> configuration file for such a deployment in the OpenShift Platform:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HostDeviceNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostdevice-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;hostdev&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.3.225/28&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;exclude&quot;: [</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.229/30&quot;,</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.236/32&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">]</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">host-net-gpudirect-pod.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testpod1</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostdevice-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appcntr1</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;image&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;IPC_LOCK&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep inf</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/hostdev</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/hostdev</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-in-sr-iov-legacy-mode">
<h3>Network Operator Deployment in SR-IOV Legacy Mode<a class="headerlink" href="#network-operator-deployment-in-sr-iov-legacy-mode" title="Permalink to this headline"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The SR-IOV Network Operator will be deployed with the default configuration. You can override these settings using a CLI argument, or the ‘sriov-network-operator’ section in the values.yaml file. For more information, refer to the <a class="reference external" href="https://github.com/k8snetworkplumbingwg/sriov-network-operator/">Project Documentation</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This deployment mode supports SR-IOV in legacy mode.</p>
</div>
<p>First install the Network Operator with NFD and SRIOV Network Operator enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="nt">sriovNetworkOperator</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator is installed create a NicClusterPolicy with:
* DOCA driver
* Secondary network
* Multus CNI
* IPoIB CNI
* IPAM CNI plugin</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">ofedDriver</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doca-driver</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24.10-0.6.2.0-0</span><span class="w"></span>
<span class="w">     </span><span class="nt">forcePrecompiled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">     </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">     </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">upgradePolicy</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">autoUpgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">       </span><span class="nt">maxParallelUpgrades</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">       </span><span class="nt">safeLoad</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">       </span><span class="nt">drain</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">force</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">         </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">         </span><span class="nt">deleteEmptyDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipamPlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.7.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p>Following the deployment, the Network Operator should be configured, and sriovnetwork node policy and K8s networking should be deployed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sriovnetwork-node-policy.yaml</span></code> configuration file for such a deployment:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkNodePolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy-1</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">deviceType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netdevice</span><span class="w"></span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">  </span><span class="nt">nicSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;15b3&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">pfNames</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ens2f0&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">feature.node.kubernetes.io/pci-15b3.present</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">numVfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w"></span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span><span class="w"></span>
<span class="w">  </span><span class="nt">isRdma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov_resource</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sriovnetwork.yaml</span></code> configuration file for such a deployment:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;example-sriov-network&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">vlan</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sriov_resource&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;datastore&quot;: &quot;kubernetes&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;kubernetes&quot;: {</span><span class="w"></span>
<span class="w">        </span><span class="no">&quot;kubeconfig&quot;: &quot;/etc/cni/net.d/whereabouts.d/whereabouts.kubeconfig&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">},</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_file&quot;: &quot;/tmp/whereabouts.log&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_level&quot;: &quot;debug&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.101.0/24&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The ens2f0 network interface name has been chosen from the following command output: <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">-n</span> <span class="pre">nvidia-network-operator</span> <span class="pre">get</span> <span class="pre">sriovnetworknodestates.sriovnetwork.openshift.io</span> <span class="pre">-o</span> <span class="pre">yaml</span></code>.</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">...</span><span class="w"></span>

<span class="nt">status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">interfaces</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">deviceID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">101d</span><span class="w"></span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlx5_core</span><span class="w"></span>
<span class="w">    </span><span class="nt">linkSpeed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100000 Mb/s</span><span class="w"></span>
<span class="w">    </span><span class="nt">linkType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ETH</span><span class="w"></span>
<span class="w">    </span><span class="nt">mac</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0c:42:a1:2b:74:ae</span><span class="w"></span>
<span class="w">    </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ens2f0</span><span class="w"></span>
<span class="w">    </span><span class="nt">pciAddress</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0000:07:00.0&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">totalvfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15b3</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">deviceID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">101d</span><span class="w"></span>
<span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlx5_core</span><span class="w"></span>
<span class="w">    </span><span class="nt">linkType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ETH</span><span class="w"></span>
<span class="w">    </span><span class="nt">mac</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0c:42:a1:2b:74:af</span><span class="w"></span>
<span class="w">    </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ens2f1</span><span class="w"></span>
<span class="w">    </span><span class="nt">pciAddress</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0000:07:00.1&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">totalvfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15b3</span><span class="w"></span>

<span class="nn">...</span><span class="w"></span>
</pre></div>
</div>
<p>Wait for all required pods to be spawned:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># kubectl get pod -n nvidia-network-operator | grep sriov</span>
network-operator-sriov-network-operator-544c8dbbb9-vzkmc          <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
sriov-device-plugin-vwpzn                                         <span class="m">1</span>/1     Running   <span class="m">0</span>          2d6h
sriov-network-config-daemon-qv467                                 <span class="m">3</span>/3     Running   <span class="m">0</span>          5d
<span class="c1"># kubectl get pod -n nvidia-network-operator</span>
NAME                                            READY   STATUS    RESTARTS   AGE
cni-plugins-ds-kbvnm                            <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
cni-plugins-ds-pcllg                            <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
kube-multus-ds-5j6ns                            <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
kube-multus-ds-mxgvl                            <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
mofed-ubuntu20.04-ds-2zzf4                      <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
mofed-ubuntu20.04-ds-rfnsw                      <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
whereabouts-nw7hn                               <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
whereabouts-zvhrv                               <span class="m">1</span>/1     Running   <span class="m">0</span>          5d
...
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">pod.yaml</span></code> configuration file for such a deployment:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testpod1</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-sriov-network</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appcntr1</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;image&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;IPC_LOCK&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/sriov_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/sriov_resource</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep inf</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sr-iov-network-operator-deployment-parallel-node-configuration-for-sr-iov">
<h3>SR-IOV Network Operator Deployment – Parallel Node Configuration for SR-IOV<a class="headerlink" href="#sr-iov-network-operator-deployment-parallel-node-configuration-for-sr-iov" title="Permalink to this headline"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is supported only for Vanilla Kubernetes deployments with SR-IOV Network Operator.</p>
</div>
<p>To apply SR-IOV configuration on several nodes in parallel, create a <code class="docutils literal notranslate"><span class="pre">SriovNetworkPoolConfig</span></code> CR and specify the maximum number or percentage of nodes that can be unavailable at the same time:</p>
<p><code class="docutils literal notranslate"><span class="pre">sriov-network-pool-config-number.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkPoolConfig</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pool-1</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;20&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">some-label</span><span class="w"></span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span><span class="w"></span>
<span class="w">        </span><span class="nt">values</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">val-2</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">other-label</span><span class="w"></span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Exists&quot;</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sriov-network-pool-config-percent.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkPoolConfig</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pool-1</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10%&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">some-label</span><span class="w"></span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span><span class="w"></span>
<span class="w">        </span><span class="nt">values</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">val-2</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">other-label</span><span class="w"></span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Exists&quot;</span><span class="w"></span>
</pre></div>
</div>
<section id="upgrade-from-nvidia-network-operator-v24-1-0">
<h4>Upgrade from NVIDIA Network Operator v24.1.0<a class="headerlink" href="#upgrade-from-nvidia-network-operator-v24-1-0" title="Permalink to this headline"></a></h4>
<p>To upgrade SR-IOV Network operator you need to create <code class="docutils literal notranslate"><span class="pre">SriovNetworkPoolConfig</span></code> CR with the number of nodes to be configured in a parallel as we did in <cite>SriovOperatorConfig`</cite> in previous releases.</p>
<p>E.g.: old method to configure nodes in a parallel:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl patch sriovoperatorconfigs.sriovnetwork.openshift.io -n nvidia-network-operator default --patch <span class="s1">&#39;{ &quot;spec&quot;: { &quot;maxParallelNodeConfiguration&quot;: 5 } }&#39;</span> --type<span class="o">=</span><span class="s1">&#39;merge&#39;</span>
</pre></div>
</div>
<p>New  method to configure nodes in a parallel:</p>
<p><code class="docutils literal notranslate"><span class="pre">sriov-network-pool-config-new.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkPoolConfig</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pool-1</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-role.kubernetes.io/master</span><span class="w"></span>
<span class="w">            </span><span class="l l-Scalar l-Scalar-Plain">operator</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="sr-iov-network-operator-deployment-parallel-nic-configuration-for-sr-iov">
<h3>SR-IOV Network Operator Deployment – Parallel NIC Configuration for SR-IOV<a class="headerlink" href="#sr-iov-network-operator-deployment-parallel-nic-configuration-for-sr-iov" title="Permalink to this headline"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is supported only for Vanilla Kubernetes deployments with SR-IOV Network Operator.</p>
</div>
<p>To apply SriovNetworkNodePolicy on several nodes in parallel, specify the <code class="docutils literal notranslate"><span class="pre">featureGates</span></code> option in the SriovOperatorConfig CRD:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl patch sriovoperatorconfigs.sriovnetwork.openshift.io -n nvidia-network-operator default --patch <span class="s1">&#39;{ &quot;spec&quot;: { &quot;featureGates&quot;: { &quot;parallelNicConfig&quot;: true  } } }&#39;</span> --type<span class="o">=</span><span class="s1">&#39;merge&#39;</span>
</pre></div>
</div>
</section>
<section id="sr-iov-network-operator-deployment-sr-iov-using-the-systemd-service">
<h3>SR-IOV Network Operator Deployment – SR-IOV Using the systemd Service<a class="headerlink" href="#sr-iov-network-operator-deployment-sr-iov-using-the-systemd-service" title="Permalink to this headline"></a></h3>
<p>To enable systemd SR-IOV configuration mode, specify the configurationMode option in the SriovOperatorConfig CRD:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl patch sriovoperatorconfigs.sriovnetwork.openshift.io -n nvidia-network-operator default --patch <span class="s1">&#39;{ &quot;spec&quot;: { &quot;configurationMode&quot;: &quot;systemd&quot;} }&#39;</span> --type<span class="o">=</span><span class="s1">&#39;merge&#39;</span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-with-an-sr-iov-infiniband-network">
<h3>Network Operator Deployment with an SR-IOV InfiniBand Network<a class="headerlink" href="#network-operator-deployment-with-an-sr-iov-infiniband-network" title="Permalink to this headline"></a></h3>
<p>Network Operator deployment with InfiniBand network requires the following:</p>
<ul class="simple">
<li><p>NVIDIA DOCA Driver and OpenSM running. OpenSM runs on top of the NVIDIA DOCA Driver stack, so both the driver and the subnet manager should come from the same installation. Note that partitions that are configured by OpenSM should specify defmember=full to enable the SR-IOV functionality over InfiniBand. For more details, please refer to this <a class="reference external" href="https://docs.mellanox.com/display/MLNXOFEDv51258060/OpenSM">article</a>.</p></li>
<li><p>InfiniBand device – Both the host device and switch ports must be enabled in InfiniBand mode.</p></li>
<li><p>rdma-core package should be installed when an inbox driver is used.</p></li>
</ul>
<p>First install the Network Operator with NFD and SR-IOV Network Operator enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="nt">sriovNetworkOperator</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator is installed create a NicClusterPolicy with:
* DOCA driver
* Secondary network
* Multus CNI
* Container Networking Plugins
* IPAM plugin</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">ofedDriver</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doca-driver</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24.10-0.6.2.0-0</span><span class="w"></span>
<span class="w">     </span><span class="nt">forcePrecompiled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">     </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">     </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">upgradePolicy</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">autoUpgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">       </span><span class="nt">maxParallelUpgrades</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">       </span><span class="nt">safeLoad</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">       </span><span class="nt">drain</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">force</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">         </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">         </span><span class="nt">deleteEmptyDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipamPlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.7.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sriov-ib-network-node-policy.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkNodePolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">infiniband-sriov</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">deviceType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netdevice</span><span class="w"></span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">feature.node.kubernetes.io/pci-15b3.present</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">nicSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;15b3&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">linkType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IB</span><span class="w"></span>
<span class="w">  </span><span class="nt">isRdma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">numVfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w"></span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlnxnics</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sriov-ib-network.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovIBNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-sriov-ib-network</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;datastore&quot;: &quot;kubernetes&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;kubernetes&quot;: {</span><span class="w"></span>
<span class="w">        </span><span class="no">&quot;kubeconfig&quot;: &quot;/etc/cni/net.d/whereabouts.d/whereabouts.kubeconfig&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">},</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.5.225/28&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;exclude&quot;: [</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.5.229/30&quot;,</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.5.236/32&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">],</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_file&quot;: &quot;/var/log/whereabouts.log&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_level&quot;: &quot;info&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlnxnics</span><span class="w"></span>
<span class="w">  </span><span class="nt">linkState</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enable</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sriov-ib-network-pod.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-sriov-ib-pod</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-sriov-ib-network</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-sriov-ib-pod</span><span class="w"></span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">centos/tools</span><span class="w"></span>
<span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep inf</span><span class="w"></span>
<span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;IPC_LOCK&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">nvidia.com/mlnxics</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">nvidia.com/mlnxics</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-with-an-sr-iov-infiniband-network-with-pkey-management">
<h3>Network Operator Deployment with an SR-IOV InfiniBand Network with PKey Management<a class="headerlink" href="#network-operator-deployment-with-an-sr-iov-infiniband-network-with-pkey-management" title="Permalink to this headline"></a></h3>
<p>Network Operator deployment with InfiniBand network requires the following:</p>
<ul class="simple">
<li><p>NVIDIA DOCA Driver and OpenSM running. OpenSM runs on top of the NVIDIA DOCA Driver stack, so both the driver and the subnet manager should come from the same installation. Note that partitions that are configured by OpenSM should specify defmember=full to enable the SR-IOV functionality over InfiniBand. For more details, please refer to <a class="reference external" href="https://docs.mellanox.com/display/MLNXOFEDv51258060/OpenSM">this article</a>.</p></li>
<li><p>NVIDIA UFM running on top of OpenSM. For more details, please refer to <a class="reference external" href="https://docs.nvidia.com/networking/display/UFMEnterpriseUMv652">the project documentation</a>.</p></li>
<li><p>InfiniBand device – Both the host device and the switch ports must be enabled in InfiniBand mode.</p></li>
<li><p>rdma-core package should be installed when an inbox driver is used.</p></li>
</ul>
<p>Current limitations:</p>
<ul class="simple">
<li><p>Only a single PKey can be configured per workload pod.</p></li>
<li><p>When a single instance of NVIDIA UFM is used with several K8s clusters, different PKey GUID pools should be configured for each cluster.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ib-kubernetes provides a daemon that works in conjunction with the <a class="reference external" href="https://github.com/openshift/sriov-network-operator">SR-IOV Network Device Plugin</a>. It acts on Kubernetes pod object changes (Create/Update/Delete), reading the pod’s network annotation, fetching its corresponding network CRD and reading the PKey. This is done in order to add the newly generated GUID or the predefined GUID in the GUID field of the CRD cni-args to that PKey for pods with <code class="docutils literal notranslate"><span class="pre">mellanox.infiniband.app</span></code> annotation.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><cite>ib-kubernetes-ufm-secret</cite> should be created before NicClusterPolicy.</p>
</div>
<p>IB Kubernetes must access <a class="reference external" href="https://www.nvidia.com/en-us/networking/infiniband/ufm/">NVIDIA UFM</a> in order to manage pods’ GUIDs. To provide its credentials, the secret of the following format should be deployed in advance:</p>
<p><code class="docutils literal notranslate"><span class="pre">ufm-secret.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ib-kubernetes-ufm-secret</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">stringData</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">UFM_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;admin&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">UFM_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;123456&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">UFM_ADDRESS</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ufm-host&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">UFM_HTTP_SCHEMA</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">UFM_PORT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="nt">data</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">UFM_CERTIFICATE</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>First install the Network Operator with NFD enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nfd</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="nt">sriovNetworkOperator</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourcePrefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nvidia.com&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator is installed create a NicClusterPolicy with:
* DOCA driver
* ibKubernetes
* Secondary network
* Multus CNI
* Container Networking plugins
* IPAM Plugin</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">ofedDriver</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doca-driver</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24.10-0.6.2.0-0</span><span class="w"></span>
<span class="w">     </span><span class="nt">forcePrecompiled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">     </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w"></span>
<span class="w">     </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">       </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">     </span><span class="nt">upgradePolicy</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">autoUpgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">       </span><span class="nt">maxParallelUpgrades</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">       </span><span class="nt">safeLoad</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">       </span><span class="nt">drain</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">force</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">         </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">         </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span><span class="w"></span>
<span class="w">         </span><span class="nt">deleteEmptyDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">   </span><span class="nt">ibKubernetes</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ib-kubernetes</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.1.0</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">pKeyGUIDPoolRangeStart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">02:00:00:00:00:00:00:00</span><span class="w"></span>
<span class="w">     </span><span class="nt">pKeyGUIDPoolRangeEnd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">02:FF:FF:FF:FF:FF:FF:FF</span><span class="w"></span>
<span class="w">     </span><span class="nt">ufmSecret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ufm-secret&quot;</span><span class="w"></span>
<span class="w">   </span><span class="nt">nvIpam</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-k8s-ipam</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.2.0</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">enableWebhook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p>Create IPPool object for nv-ipam</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nv-ipam.nvidia.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pool1</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.0/16</span><span class="w"></span>
<span class="w">  </span><span class="nt">perNodeBlockSize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w"></span>
<span class="w">  </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.1</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-role.kubernetes.io/worker</span><span class="w"></span>
<span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span><span class="w"></span>
</pre></div>
</div>
<p>Wait for NVIDIA DOCA Driver to install and apply the following CRs:</p>
<p><code class="docutils literal notranslate"><span class="pre">sriov-ib-network-node-policy.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkNodePolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">infiniband-sriov</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">deviceType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netdevice</span><span class="w"></span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">feature.node.kubernetes.io/pci-15b3.present</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">nicSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;15b3&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">linkType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IB</span><span class="w"></span>
<span class="w">  </span><span class="nt">isRdma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">numVfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w"></span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mlnxnics</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sriov-ib-network.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ib-sriov-network</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia.com/mlnxnics</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;ib-sriov&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;ib-sriov-network&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;pkey&quot;:</span><span class="nv"> </span><span class="s">&quot;0x6&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;link_state&quot;:</span><span class="nv"> </span><span class="s">&quot;enable&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;ibKubernetesEnabled&quot;:</span><span class="nv"> </span><span class="s">true,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;nv-ipam&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;poolName&quot;:</span><span class="nv"> </span><span class="s">&quot;pool1&quot;</span><span class="w"></span>
<span class="w">    </span><span class="s">}</span><span class="w"></span>
<span class="s">}&#39;</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To use the IB network with Pkey management feature with RDMA isolation, use the following <code class="docutils literal notranslate"><span class="pre">sriov-ib-network.yaml</span></code>:</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ib-sriov-network</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia.com/mlnxnics</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;ib-sriov-network&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;plugins&quot;:</span><span class="nv"> </span><span class="s">[</span><span class="w"></span>
<span class="w">  </span><span class="s">{</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;ib-sriov&quot;,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;pkey&quot;:</span><span class="nv"> </span><span class="s">&quot;0x6&quot;,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;link_state&quot;:</span><span class="nv"> </span><span class="s">&quot;enable&quot;,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;ibKubernetesEnabled&quot;:</span><span class="nv"> </span><span class="s">true,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;nv-ipam&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;poolName&quot;:</span><span class="nv"> </span><span class="s">&quot;pool1&quot;</span><span class="w"></span>
<span class="w">    </span><span class="s">}</span><span class="w"></span>
<span class="w">  </span><span class="s">},</span><span class="w"></span>
<span class="w">  </span><span class="s">{</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;rdma&quot;</span><span class="w"></span>
<span class="w">  </span><span class="s">}</span><span class="w"></span>
<span class="w">  </span><span class="s">]</span><span class="w"></span>
<span class="s">}&#39;</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sriov-ib-network-pod.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-sriov-ib-pod</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ib-sriob-network</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-sriov-ib-pod</span><span class="w"></span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">centos/tools</span><span class="w"></span>
<span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sleep inf</span><span class="w"></span>
<span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;IPC_LOCK&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">nvidia.com/mlnxics</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">nvidia.com/mlnxics</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-for-dpdk-workloads-with-nicclusterpolicy">
<h3>Network Operator Deployment for DPDK Workloads with NicClusterPolicy<a class="headerlink" href="#network-operator-deployment-for-dpdk-workloads-with-nicclusterpolicy" title="Permalink to this headline"></a></h3>
<p>This deployment mode supports DPDK applications. In order to run DPDK applications, <a class="reference external" href="http://manpages.ubuntu.com/manpages/focal/man8/hugeadm.8.html">HUGEPAGE</a> should be configured on the required K8s Worker Nodes. By default, the inbox operating system driver is used. For support of cases with specific requirements, OFED container should be deployed.</p>
<p>Network Operator deployment with:</p>
<ul class="simple">
<li><p>Host Device Network</p></li>
<li><p>DPDK pod</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">nicclusterpolicy.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">ofedDriver</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">doca-driver</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvcr.io/nvidia/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24.10-0.6.2.0-0</span><span class="w"></span>
<span class="w">   </span><span class="nt">sriovDevicePlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-network-device-plugin</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.7.0</span><span class="w"></span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">config</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">       </span><span class="no">{</span><span class="w"></span>
<span class="w">         </span><span class="no">&quot;resourceList&quot;: [</span><span class="w"></span>
<span class="w">             </span><span class="no">{</span><span class="w"></span>
<span class="w">                 </span><span class="no">&quot;resourcePrefix&quot;: &quot;nvidia.com&quot;,</span><span class="w"></span>
<span class="w">                 </span><span class="no">&quot;resourceName&quot;: &quot;rdma_host_dev&quot;,</span><span class="w"></span>
<span class="w">                 </span><span class="no">&quot;selectors&quot;: {</span><span class="w"></span>
<span class="w">                     </span><span class="no">&quot;vendors&quot;: [&quot;15b3&quot;],</span><span class="w"></span>
<span class="w">                     </span><span class="no">&quot;devices&quot;: [&quot;1018&quot;],</span><span class="w"></span>
<span class="w">                     </span><span class="no">&quot;drivers&quot;: [&quot;mlx5_core&quot;]</span><span class="w"></span>
<span class="w">                 </span><span class="no">}</span><span class="w"></span>
<span class="w">             </span><span class="no">}</span><span class="w"></span>
<span class="w">         </span><span class="no">]</span><span class="w"></span>
<span class="w">       </span><span class="no">}</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0-amd64</span><span class="w"></span>
<span class="w">     </span><span class="nt">ipamPlugin</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whereabouts</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.7.0-amd64</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">host-device-net.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HostDeviceNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-hostdev-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rdma_host_dev&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;whereabouts&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;datastore&quot;: &quot;kubernetes&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;kubernetes&quot;: {</span><span class="w"></span>
<span class="w">        </span><span class="no">&quot;kubeconfig&quot;: &quot;/etc/cni/net.d/whereabouts.d/whereabouts.kubeconfig&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">},</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;range&quot;: &quot;192.168.3.225/28&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;exclude&quot;: [</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.229/30&quot;,</span><span class="w"></span>
<span class="w">       </span><span class="no">&quot;192.168.3.236/32&quot;</span><span class="w"></span>
<span class="w">      </span><span class="no">],</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_file&quot; : &quot;/var/log/whereabouts.log&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;log_level&quot; : &quot;info&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pod.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testpod1</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-hostdev-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appcntr1</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;dpdk image&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;IPC_LOCK&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/hugepages</span><span class="w"></span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hugepage</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span><span class="w"></span>
<span class="w">        </span><span class="nt">hugepages-1Gi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2Gi</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/rdma_host_dev</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/bin/bash&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;while</span><span class="nv"> </span><span class="s">true;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">300000;</span><span class="nv"> </span><span class="s">done;&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hugepage</span><span class="w"></span>
<span class="w">     </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">medium</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HugePages</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="network-operator-deployment-and-openvswitch-offload-managed-openvswitch">
<h3>Network Operator Deployment and OpenvSwitch offload - managed OpenvSwitch<a class="headerlink" href="#network-operator-deployment-and-openvswitch-offload-managed-openvswitch" title="Permalink to this headline"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is supported only for Vanilla Kubernetes deployments with SR-IOV Network Operator.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>To use OFED container with this mode of operation, set the <cite>RESTORE_DRIVER_ON_POD_TERMINATION</cite> environment variable to <cite>false</cite> in the driver configuration section in the NicClusterPolicy. Restoration to the inbox driver is not supported for this feature.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Tech Preview feature.</p>
</div>
<p>In this mode, the sriov-network-operator automatically creates and configures OpenvSwitch bridges.
For more complex scenarios, such as VF lag, you must use the “externally managed OpenvSwitch” feature of the sriov-network-operator,
which is detailed in a separate section of the documentation.</p>
<section id="network-operator-configuration">
<h4>Network Operator Configuration<a class="headerlink" href="#network-operator-configuration" title="Permalink to this headline"></a></h4>
<p>Deploy network-operator by Helm with sriov-network-operator and nv-ipam.</p>
<p>First install the Network Operator with NFD enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sriovNetworkOperator</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator has been installed create a NicClusterPolicy with nv-ipam:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">nvIpam</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-k8s-ipam</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.2.0</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">enableWebhook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p>Enable <code class="docutils literal notranslate"><span class="pre">manageSoftwareBridges</span></code> featureGate for sriov-network-operator</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl patch sriovoperatorconfigs.sriovnetwork.openshift.io -n nvidia-network-operator default --patch <span class="s1">&#39;{ &quot;spec&quot;: { &quot;featureGates&quot;: { &quot;manageSoftwareBridges&quot;: true  } } }&#39;</span> --type<span class="o">=</span><span class="s1">&#39;merge&#39;</span>
</pre></div>
</div>
<p>Create IPPool object for nv-ipam</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nv-ipam.nvidia.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pool1</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.0/16</span><span class="w"></span>
<span class="w">  </span><span class="nt">perNodeBlockSize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w"></span>
<span class="w">  </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.1</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-role.kubernetes.io/worker</span><span class="w"></span>
<span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="prerequisites-for-worker-nodes">
<h4>Prerequisites for Worker Nodes<a class="headerlink" href="#prerequisites-for-worker-nodes" title="Permalink to this headline"></a></h4>
<p>Supported operating systems:</p>
<ul class="simple">
<li><p>Ubuntu 22.04</p></li>
</ul>
<p>OpenvSwitch from the <code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">DOCA</span> <span class="pre">for</span> <span class="pre">Host</span></code> package with <code class="docutils literal notranslate"><span class="pre">doca-all</span></code> or <code class="docutils literal notranslate"><span class="pre">doca-networking</span></code> profile should be installed on each worker node.</p>
<p>Check NVIDIA DOCA <a class="reference external" href="https://docs.nvidia.com/doca/sdk/nvidia+doca+installation+guide+for+linux/index.html">Official installation guide</a>
for details.</p>
<p>Supported OpenvSwitch dataplanes:</p>
<ul class="simple">
<li><p>OVS-kernel</p></li>
<li><p>OVS-doca</p></li>
</ul>
<p>Check <a class="reference external" href="https://docs.nvidia.com/doca/sdk/openvswitch+offload+(ovs+in+doca)/index.html">OpenvSwitch Offload</a> document to know about differences.</p>
</section>
<section id="ovs-kernel">
<h4>OVS-kernel<a class="headerlink" href="#ovs-kernel" title="Permalink to this headline"></a></h4>
<p><em>These steps are for OVS-kernel data plane, to use OVS-doca follow instructions from the relevant section.</em></p>
<section id="prepare-worker-nodes">
<h5>Prepare Worker Nodes<a class="headerlink" href="#prepare-worker-nodes" title="Permalink to this headline"></a></h5>
<p>Configure Open_vSwitch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ovs-vsctl <span class="nb">set</span> Open_vSwitch . other_config:hw-offload<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>Restart Open_vSwitch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl restart openvswitch-switch.service
</pre></div>
</div>
</section>
<section id="sriov-network-operator-configuration">
<h5>Sriov Network Operator Configuration<a class="headerlink" href="#sriov-network-operator-configuration" title="Permalink to this headline"></a></h5>
<p>Create SriovNetworkNodePolicy for selected NIC</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkNodePolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">eSwitchMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">  </span><span class="nt">nicSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">deviceID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">101d</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15b3</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">node-role.kubernetes.io/worker</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">numVfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"></span>
<span class="w">  </span><span class="nt">isRdma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">linkType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ETH</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">bridge</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">ovs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
</pre></div>
</div>
<p>Create OVSNetwork CR</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVSNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;nv-ipam&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;poolName&quot;: &quot;pool1&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="ovs-doca">
<h4>OVS-doca<a class="headerlink" href="#ovs-doca" title="Permalink to this headline"></a></h4>
<p><em>These steps are for OVS-doca data plane, to use OVS-kernel follow instructions from the relevant section.</em></p>
<section id="id1">
<h5>Prepare Worker Nodes<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h5>
<p>Configure hugepages</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p /hugepages
mount -t hugetlbfs hugetlbfs /hugepages
<span class="nb">echo</span> <span class="m">4096</span> &gt; /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages
</pre></div>
</div>
<p><em>Note: for multi CPU system hugepages should be created for each NUMA node: node0, node1, …</em></p>
<p>Configure system to create hugepages on boot</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;vm.nr_hugepages=8192&quot;</span> &gt; /etc/sysctl.d/99-hugepages.conf
</pre></div>
</div>
<p><em>Note: this example is for a server with two CPU</em></p>
<p>Configure Open_vSwitch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ovs-vsctl --no-wait <span class="nb">set</span> Open_vSwitch . other_config:doca-init<span class="o">=</span><span class="nb">true</span>
ovs-vsctl <span class="nb">set</span> Open_vSwitch . other_config:hw-offload<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>Restart Open_vSwitch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl restart openvswitch-switch.service
</pre></div>
</div>
</section>
<section id="id2">
<h5>Sriov Network Operator Configuration<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h5>
<p>Create SriovNetworkNodePolicy for selected NIC</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkNodePolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">eSwitchMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">  </span><span class="nt">nicSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">deviceID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">101d</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15b3</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">node-role.kubernetes.io/worker</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">numVfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"></span>
<span class="w">  </span><span class="nt">isRdma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">linkType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ETH</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">bridge</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">ovs</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">bridge</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">datapathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netdev</span><span class="w"></span>
<span class="w">      </span><span class="nt">uplink</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">interface</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dpdk</span><span class="w"></span>
</pre></div>
</div>
<p>Create OVSNetwork CR</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVSNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;nv-ipam&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;poolName&quot;: &quot;pool1&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">interfaceType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dpdk</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="test-workload">
<h4>Test Workload<a class="headerlink" href="#test-workload" title="Permalink to this headline"></a></h4>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload</span><span class="w"></span>
<span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload-container</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/bash&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">          </span><span class="no">while true; do sleep 1000; done</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox/rping-test</span><span class="w"></span>
<span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;IPC_LOCK&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">nvidia.com/switchdev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">nvidia.com/switchdev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="troubleshooting-ovs">
<h4>Troubleshooting OVS<a class="headerlink" href="#troubleshooting-ovs" title="Permalink to this headline"></a></h4>
<p>Please see the following DOCA documentation for OVS hardware offload verification and troubleshooting steps:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.nvidia.com/doca/sdk/ovs-kernel+hardware+offloads/index.html">OVS-Kernel Hardware Offloads</a></p></li>
<li><p><a class="reference external" href="https://docs.nvidia.com/doca/sdk/ovs-doca+hardware+offloads/index.html">OVS-DOCA Hardware Offloads</a></p></li>
</ul>
</section>
</section>
<section id="network-operator-deployment-and-openvswitch-offload-externally-managed-openvswitch-with-vf-lag">
<h3>Network Operator Deployment and OpenvSwitch offload - externally managed OpenvSwitch with VF lag<a class="headerlink" href="#network-operator-deployment-and-openvswitch-offload-externally-managed-openvswitch-with-vf-lag" title="Permalink to this headline"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is not compatible with the OFED container.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is supported only for Vanilla Kubernetes deployments with SR-IOV Network Operator.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Tech Preview feature.</p>
</div>
<p>In this mode, the sriov-network-operator is responsible for configuring the physical and virtual functions but will not manage the configuration of the software bridge.
The VF LAG and Open vSwitch should be preconfigured on the host.</p>
<section id="id3">
<h4>Network Operator Configuration<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h4>
<p>Deploy network-operator by Helm with sriov-network-operator and nv-ipam.</p>
<p>First install the Network Operator with NFD enabled:
<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sriovNetworkOperator</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<p>Once the Network Operator has been installed create a NicClusterPolicy with nv-ipam:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox.com/v1alpha1</span><span class="w"></span>
<span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NicClusterPolicy</span><span class="w"></span>
<span class="w"> </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nic-cluster-policy</span><span class="w"></span>
<span class="w"> </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="nt">nvIpam</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-k8s-ipam</span><span class="w"></span>
<span class="w">     </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/mellanox</span><span class="w"></span>
<span class="w">     </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.2.0</span><span class="w"></span>
<span class="w">     </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">enableWebhook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">   </span><span class="nt">secondaryNetwork</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="nt">cniPlugins</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">plugins</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.5.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">     </span><span class="nt">multus</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multus-cni</span><span class="w"></span>
<span class="w">       </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/k8snetworkplumbingwg</span><span class="w"></span>
<span class="w">       </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.1.0</span><span class="w"></span>
<span class="w">       </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
</pre></div>
</div>
<p>Switch sriov-network-operator to <cite>systemd</cite> configuration mode.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl patch sriovoperatorconfigs.sriovnetwork.openshift.io -n nvidia-network-operator default --patch <span class="s1">&#39;{ &quot;spec&quot;: { &quot;configurationMode&quot;: &quot;systemd&quot;} }&#39;</span> --type<span class="o">=</span><span class="s1">&#39;merge&#39;</span>
</pre></div>
</div>
<p>Create IPPool object for nv-ipam</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nv-ipam.nvidia.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPPool</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pool1</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.0/16</span><span class="w"></span>
<span class="w">  </span><span class="nt">perNodeBlockSize</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w"></span>
<span class="w">  </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.1</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-role.kubernetes.io/worker</span><span class="w"></span>
<span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id4">
<h4>Prerequisites for Worker Nodes<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h4>
<p>Supported operating systems:</p>
<ul class="simple">
<li><p>Ubuntu 22.04</p></li>
</ul>
<p>OpenvSwitch from the <code class="docutils literal notranslate"><span class="pre">NVIDIA</span> <span class="pre">DOCA</span> <span class="pre">for</span> <span class="pre">Host</span></code> package with <code class="docutils literal notranslate"><span class="pre">doca-all</span></code> or <code class="docutils literal notranslate"><span class="pre">doca-networking</span></code> profile should be installed on each worker node.</p>
<p>Check NVIDIA DOCA <a class="reference external" href="https://docs.nvidia.com/doca/sdk/nvidia+doca+installation+guide+for+linux/index.html">Official installation guide</a>
for details.</p>
<p>Supported OpenvSwitch dataplanes:</p>
<ul class="simple">
<li><p>OVS-kernel</p></li>
<li><p>OVS-doca</p></li>
</ul>
<p>Check <a class="reference external" href="https://docs.nvidia.com/doca/sdk/openvswitch+offload+(ovs+in+doca)/index.html">OpenvSwitch Offload</a> document to know about differences.</p>
<section id="configure-bond-interface-with-netplan">
<h5>Configure Bond interface with netplan<a class="headerlink" href="#configure-bond-interface-with-netplan" title="Permalink to this headline"></a></h5>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of /etc/netplan/01-uplink-bond.yaml</span>
network:
  version: <span class="m">2</span>
  renderer: networkd
  ethernets:
    enp4s0f0np0:
      dhcp4: no
      dhcp6: no
    enp4s0f1np1:
      dhcp4: no
      dhcp6: no
  bonds:
    bond0:
      dhcp4: no
      dhcp6: no
      interfaces:
        - enp4s0f0np0
        - enp4s0f1np1
      parameters:
        mode: <span class="m">802</span>.3ad
</pre></div>
</div>
<p><em>Replace `enp4s0f0np0` and `enp4s0f1np1` with the right PF names for you node</em></p>
</section>
</section>
<section id="id7">
<h4>OVS-kernel<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h4>
<p><em>These steps are for OVS-kernel data plane, to use OVS-doca follow instructions from the relevant section.</em></p>
<section id="id8">
<h5>Prepare Worker Nodes<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h5>
<p>Configure Open_vSwitch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ovs-vsctl <span class="nb">set</span> Open_vSwitch . other_config:hw-offload<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>Restart Open_vSwitch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl restart openvswitch-switch.service
</pre></div>
</div>
<p>Create bridge</p>
<p>Create OVS bridge</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ovs-vsctl add-br mybr
<span class="c1"># this commad may fail with &quot;No such device&quot; error</span>
ovs-vsctl add-port mybr bond0
</pre></div>
</div>
<p><em>Note: the second command may fail with “No such device” error because bond0 interface is not exist yet.</em></p>
</section>
<section id="id9">
<h5>Sriov Network Operator Configuration<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h5>
<p>Create SriovNetworkNodePolicy for selected NIC</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkNodePolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">eSwitchMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">  </span><span class="nt">nicSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">deviceID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">101d</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15b3</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">node-role.kubernetes.io/worker</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">numVfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"></span>
<span class="w">  </span><span class="nt">isRdma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">linkType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ETH</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
</pre></div>
</div>
<p>Create OVSNetwork CR</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVSNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;nv-ipam&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;poolName&quot;: &quot;pool1&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="id10">
<h4>OVS-doca<a class="headerlink" href="#id10" title="Permalink to this headline"></a></h4>
<p><em>These steps are for OVS-doca data plane, to use OVS-kernel follow instructions from the relevant section.</em></p>
<section id="id11">
<h5>Prepare Worker Nodes<a class="headerlink" href="#id11" title="Permalink to this headline"></a></h5>
<p>Configure hugepages</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p /hugepages
mount -t hugetlbfs hugetlbfs /hugepages
<span class="nb">echo</span> <span class="m">4096</span> &gt; /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages
</pre></div>
</div>
<p><em>Note: for multi CPU system hugepages should be created for each NUMA node: node0, node1, …</em></p>
<p>Configure system to create hugepages on boot</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;vm.nr_hugepages=8192&quot;</span> &gt; /etc/sysctl.d/99-hugepages.conf
</pre></div>
</div>
<p><em>Note: this example is for a server with two CPU</em></p>
<p>Configure Open_vSwitch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ovs-vsctl --no-wait <span class="nb">set</span> Open_vSwitch . other_config:doca-init<span class="o">=</span><span class="nb">true</span>
ovs-vsctl <span class="nb">set</span> Open_vSwitch . other_config:hw-offload<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>Restart Open_vSwitch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl restart openvswitch-switch.service
</pre></div>
</div>
<p>Create OVS bridge</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ovs-vsctl --no-wait add-br mybr -- <span class="nb">set</span> bridge mybr <span class="nv">datapath_type</span><span class="o">=</span>netdev
<span class="c1"># this commad may fail with &quot;No such device&quot; error</span>
ovs-vsctl add-port mybr bond0 -- <span class="nb">set</span> Interface bond0 <span class="nv">type</span><span class="o">=</span>dpdk options:dpdk-lsc-interrupt<span class="o">=</span><span class="nb">true</span> <span class="nv">mtu_request</span><span class="o">=</span><span class="m">1450</span>
</pre></div>
</div>
<p><em>Note: the second command may fail with “No such device” error because bond0 interface is not exist yet.</em></p>
</section>
<section id="id12">
<h5>Sriov Network Operator Configuration<a class="headerlink" href="#id12" title="Permalink to this headline"></a></h5>
<p>Create SriovNetworkNodePolicy for selected NIC</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SriovNetworkNodePolicy</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">eSwitchMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1500</span><span class="w"></span>
<span class="w">  </span><span class="nt">nicSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">deviceID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">101d</span><span class="w"></span>
<span class="w">    </span><span class="nt">vendor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15b3</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">node-role.kubernetes.io/worker</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">numVfs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"></span>
<span class="w">  </span><span class="nt">isRdma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="nt">linkType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ETH</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
</pre></div>
</div>
<p>Create OVSNetwork CR</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriovnetwork.openshift.io/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVSNetwork</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia-network-operator</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">networkNamespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
<span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">{</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;type&quot;: &quot;nv-ipam&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="no">&quot;poolName&quot;: &quot;pool1&quot;</span><span class="w"></span>
<span class="w">    </span><span class="no">}</span><span class="w"></span>
<span class="w">  </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">switchdev</span><span class="w"></span>
<span class="w">  </span><span class="nt">interfaceType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dpdk</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="id13">
<h4>Test Workload<a class="headerlink" href="#id13" title="Permalink to this headline"></a></h4>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload</span><span class="w"></span>
<span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ovs-offload-container</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/bin/bash&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">          </span><span class="no">while true; do sleep 1000; done</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mellanox/rping-test</span><span class="w"></span>
<span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;IPC_LOCK&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">nvidia.com/switchdev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">nvidia.com/switchdev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id14">
<h4>Troubleshooting OVS<a class="headerlink" href="#id14" title="Permalink to this headline"></a></h4>
<p>Please see the following DOCA documentation for OVS hardware offload verification and troubleshooting steps:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.nvidia.com/doca/sdk/ovs-kernel+hardware+offloads/index.html">OVS-Kernel Hardware Offloads</a></p></li>
<li><p><a class="reference external" href="https://docs.nvidia.com/doca/sdk/ovs-doca+hardware+offloads/index.html">OVS-DOCA Hardware Offloads</a></p></li>
</ul>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, NVIDIA.
      <span class="lastupdated">Last updated on Nov 03, 2024.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 



</body>
</html>