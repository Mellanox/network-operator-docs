<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>K8s on Bare Metal - Ethernet &mdash; NVIDIA Network Operator 0.1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" type="text/css" />
      <link rel="stylesheet" href="_static/omni-style.css" type="text/css" />
      <link rel="stylesheet" href="_static/api-styles.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/mermaid-init.js"></script>
        <script src="_static/design-tabs.js"></script>
        <script src="_static/version.js"></script>
        <script src="_static/social-media.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Kubernetes Performance Tuning" href="kubernetes-perfomance.html" />
    <link rel="prev" title="Device Plugin" href="device-plugin.html" />
 


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >


<a href="index.html">
  <img src="_static/nvidia-logo-white.png" class="logo" alt="Logo"/>
</a>

<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">NVIDIA Network Operator</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">About the Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="platform-support.html">Platform Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started-kubernetes.html">Getting Started with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started-openshift.html">Getting Started with Red Hat OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="customizations/customization.html">Customization Options and CRDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="life-cycle-management.html">Life Cycle Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced-configurations.html">Advanced Configurations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Multi-network POD</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="multi-network-pod.html">Multi-network POD</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Device Plugin</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="device-plugin.html">Device Plugin</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">K8s on Bare Metal - Ethernet</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">K8s on Bare Metal - Ethernet</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Kubernetes Performance Tuning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="kubernetes-perfomance.html">Kubernetes Performance Tuning</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NVIDIA Network Operator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">


<li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
  
<li>K8s on Bare Metal - Ethernet</li>

      <li class="wy-breadcrumbs-aside">
      </li>
<li class="wy-breadcrumbs-aside">

  <span>&nbsp;</span>
</li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="k8s-on-bare-metal-ethernet">
<h1>K8s on Bare Metal - Ethernet<a class="headerlink" href="#k8s-on-bare-metal-ethernet" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#operating-system-requirements" id="id3">Operating System Requirements</a></p></li>
<li><p><a class="reference internal" href="#kubernetes-prerequisites" id="id4">Kubernetes Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#enabling-sr-iov-networking-with-kubernetes" id="id5">Enabling SR-IOV Networking with Kubernetes</a></p>
<ul>
<li><p><a class="reference internal" href="#supported-network-interface-cards-and-firmware" id="id6">Supported Network Interface Cards and Firmware</a></p></li>
<li><p><a class="reference internal" href="#enabling-sr-iov-virtual-functions-in-legacy-mode" id="id7">Enabling SR-IOV Virtual Functions in Legacy Mode</a></p></li>
<li><p><a class="reference internal" href="#roce-namespace-aware" id="id8">RoCE Namespace Aware</a></p></li>
<li><p><a class="reference internal" href="#roce-with-connection-manager-cm" id="id9">RoCE with Connection Manager (CM)</a></p></li>
<li><p><a class="reference internal" href="#roce-with-gpudirect" id="id10">RoCE with GPUDirect</a></p></li>
<li><p><a class="reference internal" href="#dpdk" id="id11">DPDK</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ovs-offload" id="id12">OVS Offload</a></p>
<ul>
<li><p><a class="reference internal" href="#ovn-kubernetes-cni-with-connectx" id="id13">OVN Kubernetes CNI with ConnectX</a></p></li>
<li><p><a class="reference internal" href="#antrea" id="id14">Antrea</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#roce-shared-mode" id="id15">RoCE Shared Mode</a></p>
<ul>
<li><p><a class="reference internal" href="#kubernetes-prerequisite" id="id16">Kubernetes Prerequisite</a></p></li>
<li><p><a class="reference internal" href="#deploying-the-shared-device-plugin" id="id17">Deploying the Shared Device Plugin</a></p></li>
</ul>
</li>
</ul>
</div>
<p>This chapter describes Kubernetes solutions running on bare-metal hosts with NVIDIA’s Ethernet NIC family.</p>
<section id="operating-system-requirements">
<h2>Operating System Requirements<a class="headerlink" href="#operating-system-requirements" title="Permalink to this headline"></a></h2>
<p>NVIDIA drivers should be installed as part of the operating system.</p>
</section>
<section id="kubernetes-prerequisites">
<h2>Kubernetes Prerequisites<a class="headerlink" href="#kubernetes-prerequisites" title="Permalink to this headline"></a></h2>
<p>Install kubernetes Version 1.18, or newer. You may use the following references to Install Kubernetes with deployment tools:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Bootstrapping clusters with kubeadm</a></p></li>
<li><p><a class="reference external" href="https://kubespray.io/">Installing Kubernetes with Kubespray</a></p></li>
</ul>
<p>It is recommended to use Kubernetes Version 1.18 with the following features enabled. This will ensure the best NUMA alignment between the NIC PCI and the CPU, and better utilize SR-IOV performance:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies">CPU Manager</a> - With static CPU manager policy</p></li>
<li><p><a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Topology Manager</a> - With single NUMA node policy</p></li>
</ul>
<p>Examples of how to configure CPU and topology managers can be found in the <a class="reference internal" href="kubernetes-perfomance.html"><span class="doc">Kubernetes Performance Tuning</span></a> section.</p>
</section>
<section id="enabling-sr-iov-networking-with-kubernetes">
<h2>Enabling SR-IOV Networking with Kubernetes<a class="headerlink" href="#enabling-sr-iov-networking-with-kubernetes" title="Permalink to this headline"></a></h2>
<p>This chapter describes the setup and configuration procedures of legacy SR-IOV with SR-IOV Device Plugin and SR-IOV CNI.</p>
<p>Single Root IO Virtualization (SR-IOV) is a technology that allows a physical PCIe device to present itself multiple times through the PCIe bus. This technology enables multiple virtual instances of the device with separate resources. These virtual functions can then be provisioned separately. Each VF is an additional device connected to the Physical Function. It shares the same resources with the Physical Function, and its number of ports equals those of the Physical Function.</p>
<p>The following diagram represents the POD networking interfaces with Legacy SR-IOV as a secondary network.</p>
<img alt="_images/sriovpod.png" src="_images/sriovpod.png" />
<section id="supported-network-interface-cards-and-firmware">
<h3>Supported Network Interface Cards and Firmware<a class="headerlink" href="#supported-network-interface-cards-and-firmware" title="Permalink to this headline"></a></h3>
<p>NVIDIA Networking supports the following Network Interface Cards and their corresponding firmware versions in Kubernetes:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Network Interface Card</p></th>
<th class="head"><p>Firmware Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ConnectX®-6 Dx</p></td>
<td><p>22.28.2006</p></td>
</tr>
<tr class="row-odd"><td><p>ConnectX®-6</p></td>
<td><p>20.28.2006</p></td>
</tr>
<tr class="row-even"><td><p>ConnectX®-5</p></td>
<td><p>16.28.2006</p></td>
</tr>
</tbody>
</table>
</section>
<section id="enabling-sr-iov-virtual-functions-in-legacy-mode">
<h3>Enabling SR-IOV Virtual Functions in Legacy Mode<a class="headerlink" href="#enabling-sr-iov-virtual-functions-in-legacy-mode" title="Permalink to this headline"></a></h3>
<p>SR-IOV Legacy mode supports standard network device and RDMA Over Converged Ethernet (RoCE)-enabled network device.
To enable SR-IOV virtual functions in legacy mode, follow the instructions detailed in this <a class="reference external" href="https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin/blob/master/docs/vf-setup.md#mellanox">link</a>.</p>
</section>
<section id="roce-namespace-aware">
<h3>RoCE Namespace Aware<a class="headerlink" href="#roce-namespace-aware" title="Permalink to this headline"></a></h3>
<p>Prior to Kernel Version 5.3.0, all RDMA devices were visible in all network namespaces.
Kernel Version 5.3.0 or NVIDIA OFED Version 4.7 introduce network namespace isolation of RDMA devices.
When the RDMA system is set to exclusive, this feature ensures that the RDMA device is bound to a particular net namespace and visible only to it.
To learn how to enable RoCE Namespace Aware by using RDMA CNI, see <a class="reference external" href="https://github.com/k8snetworkplumbingwg/rdma-cni/blob/v1.0.0/README.md">here</a>.</p>
<ol class="arabic simple">
<li><p>Set the RDMA system to “exclusive”. This should be done on the host preparation stage:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rdma system <span class="nb">set</span> netns exclusive
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Deploy the RDMA CNI:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl apply -f https://raw.githubusercontent.com/Mellanox/rdma-cni/v1.0.0/deployment/rdma-cni-daemonset.yaml
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Update the SR-IOV network CRD with RDMA CNI as a chained plugin:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;k8s.cni.cncf.io/v1&quot;</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-net</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nvidia.com/mlnx_sriov_netdevice</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;cniVersion&quot;:</span><span class="nv"> </span><span class="s">&quot;0.3.1&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;name&quot;:</span><span class="nv"> </span><span class="s">&quot;sriov-network&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;plugins&quot;:</span><span class="nv"> </span><span class="s">[</span><span class="w"></span>
<span class="w">    </span><span class="s">{</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;sriov&quot;,</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;ipam&quot;:</span><span class="nv"> </span><span class="s">{</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;host-local&quot;,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;subnet&quot;:</span><span class="nv"> </span><span class="s">&quot;10.56.217.0/24&quot;,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;routes&quot;:</span><span class="nv"> </span><span class="s">[</span><span class="w"></span>
<span class="w">          </span><span class="s">{</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;dst&quot;:</span><span class="nv"> </span><span class="s">&quot;0.0.0.0/0&quot;</span><span class="w"></span>
<span class="w">          </span><span class="s">}</span><span class="w"></span>
<span class="w">        </span><span class="s">],</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;gateway&quot;:</span><span class="nv"> </span><span class="s">&quot;10.56.217.1&quot;</span><span class="w"></span>
<span class="w">      </span><span class="s">}</span><span class="w"></span>
<span class="w">    </span><span class="s">},</span><span class="w"></span>
<span class="w">    </span><span class="s">{</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;type&quot;:</span><span class="nv"> </span><span class="s">&quot;rdma&quot;</span><span class="w"></span>
<span class="w">    </span><span class="s">}</span><span class="w"></span>
<span class="w">  </span><span class="s">]</span><span class="w"></span>
<span class="s">}</span><span class="w"></span>
</pre></div>
</div>
<p id="creating-sr-iov-with-roce-pod">Example of RoCE-enabled pod with SR-IOV resource:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testpod1</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appcntr1</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;rdma image&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;IPC_LOCK&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/bin/bash&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;while</span><span class="nv"> </span><span class="s">true;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">300000;</span><span class="nv"> </span><span class="s">done;&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/mlnx_sriov_netdevice</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">nvidia.com/mlnx_sriov_netdevice</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
</pre></div>
</div>
<p>The <cite>&lt;rdma image&gt;</cite> should contain RDMA user space libraries - e.g rdma-core, which are compatible with the host kernel.</p>
<p>Deploy the SR-IOV RoCE POD:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl create -f  sriov-roce-pod.yaml
</pre></div>
</div>
</section>
<section id="roce-with-connection-manager-cm">
<h3>RoCE with Connection Manager (CM)<a class="headerlink" href="#roce-with-connection-manager-cm" title="Permalink to this headline"></a></h3>
<p>Some RDMA applications use RDMA CM to establish connections across the network.
Due to kernel limitation, NVIDIA NICs require pre-allocate MACs for all VFs in the deployment, if an RDMA workload wishes to utilize RMDA CM to establish connection.</p>
<p>To do that, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ip link <span class="nb">set</span> &lt;pf-netdev&gt; vf &lt;vf-index&gt; mac &lt;mac-address&gt;
<span class="nb">echo</span> &lt;vf-pci-address&gt; &gt; /sys/bus/pci/drivers/mlx5_core/unbind
<span class="nb">echo</span> &lt;vf-pci-address&gt; &gt; /sys/bus/pci/drivers/mlx5_core/bind
</pre></div>
</div>
<p>This will populate the VF’s node and port GUID required for RDMA CM to establish connection.</p>
</section>
<section id="roce-with-gpudirect">
<h3>RoCE with GPUDirect<a class="headerlink" href="#roce-with-gpudirect" title="Permalink to this headline"></a></h3>
<p>GPUDirect allows network adapters and storage drives to directly read and write to/from GPU memory, thereby eliminating unnecessary memory copies, decreasing CPU overheads and reducing latency. These actions result in significant performance improvements.</p>
<p>GPUDirect requires the following:</p>
<ul class="simple">
<li><p>MOFED 5.5-1.0.3.2 and above</p></li>
<li><p><cite>nvidia-peermem</cite> kernel module loaded by GPU Operator v1.9.0</p></li>
<li><p>NVIDIA GPU and driver supporting GPUDirect e.g Quadro RTX 6000/8000 or Tesla T4/Tesla V100/Tesla A100</p></li>
</ul>
<p>The RoCE POD should be deployed as described in <a class="reference internal" href="#creating-sr-iov-with-roce-pod">Creating SR-IOV with RoCE POD</a>.</p>
</section>
<section id="dpdk">
<h3>DPDK<a class="headerlink" href="#dpdk" title="Permalink to this headline"></a></h3>
<p>SR-IOV DPDK support is configured similarly to SR-IOV (legacy) configuration. This section describes the differences.</p>
<ol class="arabic simple">
<li><p>Create the <cite>sriov-dpdk-pod.yaml</cite> file:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testpod1</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">k8s.v1.cni.cncf.io/networks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sriov-net</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">appcntr1</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;dpdk image&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;IPC_LOCK&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="w w-Error"> </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/hugepages</span><span class="w"></span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hugepage</span><span class="w"></span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span><span class="w"></span>
<span class="w">          </span><span class="nt">hugepages-1Gi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2Gi</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/bin/bash&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;while</span><span class="nv"> </span><span class="s">true;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">300000;</span><span class="nv"> </span><span class="s">done;&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">mellanox.com/mlnx_sriov_netdevice</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">mellanox.com/mlnx_sriov_netdevice</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span><span class="w"></span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hugepage</span><span class="w"></span>
<span class="w">     </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"></span>
<span class="w">       </span><span class="nt">medium</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HugePages</span><span class="w"></span>
</pre></div>
</div>
<p>The <cite>&lt;dpdk image&gt;</cite> should contain DPDK and RDMA user space libraries e.g - rdma-core, which are compatible with the host Kernel and with each other.</p>
<ul class="simple">
<li><p>CRI-O Version 1.17 and above requires adding <cite>NET_RAW</cite> to the capabilities (for other runtimes, <cite>NET_RAW</cite> is the default).</p></li>
<li><p>For DPDK to work with PA addresses with Linux &gt;= 4.0 requires adding <cite>SYS_ADMIN</cite> to the capabilities.</p></li>
<li><p>DPDK applications that configure the device, such as MTU, MAC and link state, require adding <cite>NET_ADMIN</cite>.</p></li>
</ul>
<p>Deploy the SR-IOV DPDK POD:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl create -f sriov-dpdk-pod.yaml
</pre></div>
</div>
</section>
</section>
<section id="ovs-offload">
<h2>OVS Offload<a class="headerlink" href="#ovs-offload" title="Permalink to this headline"></a></h2>
<p>The ASAP2 solution combines the performance and efficiency of server/storage networking hardware with the flexibility of virtual switching software. ASAP2 offers up to 10 times better performance than non offloaded OVS solutions, delivering software-defined networks with the highest total infrastructure efficiency, deployment flexibility and operational simplicity. Starting from NVIDIA® ConnectX®-5 NICs, NVIDIA supports accelerated virtual switching in server NIC hardware through the ASAP2 feature. While accelerating the data plane, ASAP2 keeps the SDN control plane intact, thus staying completely transparent to applications, maintaining flexibility and ease of deployments.</p>
<section id="ovn-kubernetes-cni-with-connectx">
<h3>OVN Kubernetes CNI with ConnectX<a class="headerlink" href="#ovn-kubernetes-cni-with-connectx" title="Permalink to this headline"></a></h3>
<p>To enable OVN Kubernetes CNI with ConnectX, see <a class="reference external" href="https://github.com/ovn-org/ovn-kubernetes/blob/master/docs/ovs_offload.md">OVN Kubernetes CNI with OVS offload</a>.</p>
</section>
<section id="antrea">
<h3>Antrea<a class="headerlink" href="#antrea" title="Permalink to this headline"></a></h3>
<p>For Antrea CNI configuration instructions, see <a class="reference external" href="https://github.com/antrea-io/antrea/blob/v0.10.0/docs/ovs-offload.md">Antrea CNI with OVS Offload</a>.</p>
</section>
</section>
<section id="roce-shared-mode">
<h2>RoCE Shared Mode<a class="headerlink" href="#roce-shared-mode" title="Permalink to this headline"></a></h2>
<p>RoCE shared mode allows RDMA devices to be shared between PODs on the same host. This configuration can work with macvlan or with ipvlan CNI.</p>
<section id="kubernetes-prerequisite">
<h3>Kubernetes Prerequisite<a class="headerlink" href="#kubernetes-prerequisite" title="Permalink to this headline"></a></h3>
<p>Install Kubernetes Version 1.16 or above. You may use the following references when installing Kubernetes with deployment tools:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Bootstrapping Clusters with Kubeadm</a></p></li>
<li><p><a class="reference external" href="https://kubespray.io/">Installing Kubernetes with Kubespray</a></p></li>
</ul>
</section>
<section id="deploying-the-shared-device-plugin">
<h3>Deploying the Shared Device Plugin<a class="headerlink" href="#deploying-the-shared-device-plugin" title="Permalink to this headline"></a></h3>
<p>Create the <cite>rdma-shared.yaml</cite> configMap for the shared device plugin:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;configList&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;resourceName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;roce_shared_devices&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;rdmaHcaMax&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;selectors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;vendors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;15b3&quot;</span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;deviceIDs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;1017&quot;</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl create -f rdma-shared.yaml
kubectl create -f https://raw.githubusercontent.com/Mellanox/k8s-rdma-shared-dev-plugin/master/images/k8s-rdma-shared-dev-plugin-ds.yaml
</pre></div>
</div>
<p>For advanced macvlan CNI configuration see following <a class="reference external" href="https://github.com/containernetworking/plugins/tree/main/plugins/main/macvlan">instructions</a>.</p>
<p>Supported IPAM (IP Address Management) operations:</p>
<ul class="simple">
<li><p>host-local</p></li>
<li><p>dhcp</p></li>
<li><p>static</p></li>
<li><p>whereabouts</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, NVIDIA.
      <span class="lastupdated">Last updated on Mar 13, 2024.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 



</body>
</html>